
<div class="calendar-container" dir="rtl">
  <div class="d-flex justify-content-center mb-4">

  <button
    mat-flat-button
    (click)="calendarVisible = true"
    (mouseenter)="isHovering = true"
    (mouseleave)="isHovering = false"
    [ngStyle]="{
      backgroundColor: isHovering ? '#512e73' : '#633c84',
      color: 'white',
      fontWeight: '700',
      borderRadius: '10px',
      padding: '12px 24px',
      fontSize: '1rem',
      boxShadow: isHovering
        ? '0 6px 15px rgba(99, 60, 132, 0.3)'
        : '0 4px 10px rgba(99, 60, 132, 0.2)',
      transition: 'all 0.3s ease',
      cursor: 'pointer',
      display: 'flex',
      alignItems: 'center'
    }"
  >
    <mat-icon
      [ngStyle]="{
        color: 'white',
        marginLeft: '8px',
        fontSize: '20px'
      }"
    >
      calendar_today
    </mat-icon>
    عرض التقويم
  </button>


</div>



  <div class="calendar-content">
<!-- <div class="side-calendar">
  <div class="calendar-card">
    <mat-calendar
      [(selected)]="selectedDate"
      (selectedChange)="onDateSelected($event)"
      [minDate]="minDate"
      [maxDate]="maxDate"
      class="custom-calendar"
    >
    </mat-calendar>
  </div>
</div> -->


<!-- Calendar Modal -->
<div class="modal-overlay" [class.visible]="calendarVisible">
  <div
    class="modal-container"
    (click)="$event.stopPropagation()"
    style="
      padding: 20px;
      border-radius: 12px;
      background: white;
    "
  >
    <button
      class="modal-close"
      (click)="calendarVisible = false"
      style="
        position: absolute;
        top: 15px;
        left: 15px;
        background: transparent;
        border: none;
        color: #999;
        cursor: pointer;
        font-size: 1.5rem;
      "
    >
      <mat-icon>close</mat-icon>
    </button>
    <h3
      style="
        text-align: center;
        color: #633c84;
        margin-top: 0;
        margin-bottom: 15px;
      "
    >
      اختر التاريخ
    </h3>
<div style="
  border-radius: 12px;
  background: white;
  box-shadow: 0 5px 20px rgba(99, 60, 132, 0.2);
  padding: 20px;
  font-family: 'Cairo', sans-serif;
">
  <div style="
    background-color: #633c84;
    color: white;
    padding: 10px;
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    margin-bottom: 10px;
  ">
    التقويم
  </div>

  <mat-calendar
    [(selected)]="selectedDate"
    (selectedChange)="onCalendarDateSelected($event)"
    [minDate]="minDate"
    [maxDate]="maxDate"
    style="
      display: block;
      font-family: 'Cairo', sans-serif;
    "
  ></mat-calendar>
</div>

  </div>
</div>


    <div class="main-calendar-view">
      @if (loading) {
      <div class="loading-overlay">
        <div class="loading-content">
          <mat-spinner diameter="50" color="accent"></mat-spinner>
          <p>جاري تحميل المواعيد...</p>
        </div>
      </div>
      } @else if (error) {
      <div class="error-overlay">
        <div class="error-content">
          <mat-icon class="error-icon">error_outline</mat-icon>
          <p>{{ error }}</p>
          <button
            mat-flat-button
            color="warn"
            (click)="loadAppointmentsForWeek()"
          >
            إعادة المحاولة
          </button>
        </div>
      </div>
      } @else {
      <div class="week-view-container">
        <div class="week-header">
          <div class="header-content">
            <button mat-icon-button class="nav-button" (click)="previousWeek()">
              <mat-icon>chevron_right</mat-icon>
            </button>
            <h2 class="week-title">{{ currentWeekRange }}</h2>
            <button mat-icon-button class="nav-button" (click)="nextWeek()">
              <mat-icon>chevron_left</mat-icon>
            </button>
          </div>
        </div>

        <div class="week-days-grid">
          @for (day of weekDays; track day.date) {
          <div class="day-column" [class.today]="isToday(day.date)">
            <div class="day-header">




              <div class="day-title">
  <h4>
    {{ day.date | date : 'd' }} {{ day.dayName }}
    <span
      *ngIf="isToday(day.date)"
      style="color: #f39c12; font-size: 0.8rem; margin-right: 5px;"
    >
      (اليوم)
    </span>
  </h4>
</div>

              <div class="day-actions">
                <button
                  mat-icon-button
                  [matMenuTriggerFor]="dayMenu"
                  class="action-button menu"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #dayMenu="matMenu">
                  <button
                    mat-menu-item
                    (click)="openDelayInput(day.dateString)"
                  >
                    <mat-icon>schedule</mat-icon>
                    <span>تأجيل المواعيد</span>
                  </button>
                  <button
                    mat-menu-item
                    (click)="openCancelModal(day.dateString)"
                  >
                    <mat-icon>cancel</mat-icon>
                    <span>إلغاء المواعيد</span>
                  </button>
                </mat-menu>
              </div>
            </div>
<mat-form-field appearance="fill" class="status-dropdown" style="height: 60px; margin-top: -6px;">
  <mat-label style="font-size: small;">الحالة</mat-label>

  <mat-select
    [(value)]="day.selectedStatus"
    (selectionChange)="onStatusChange(day)"
  >
    <mat-option *ngFor="let status of statusList" [value]="status.value">
      <mat-icon
        class="status-icon"
        [style.color]="status.color"
      >
        {{ status.icon }}
      </mat-icon>
      <span class="status-label">{{ status.label }}</span>
    </mat-option>
  </mat-select>
</mat-form-field>

          <div class="appointments-container">
  @if (day.appointments.length > 0) {
    @for (appointment of day.appointments; track appointment.id) {
      <div
        class="appointment-card"
        [ngClass]="'status-' + appointment.status"
      >
        <div class="appointment-time-badge" style="display: flex; justify-content: space-between; align-items: center;">
          <span>{{ appointment.startTime | slice : 0 : 5 }}</span>
          <span style="font-size: 12px; font-weight: bold; color: #333;">
            {{ getTypeText(appointment.appointmentType) }}
          </span>
        </div>

        <div class="appointment-details">
          <h4 class="patient-name">
            {{ appointment.patientFullName }}
          </h4>
          <div>{{ appointment.phone }}</div>
        </div>

        <div class="appointment-status">
          <mat-icon
            class="status-icon"
            [style.color]="getStatusColor(appointment.status)"
          >
            {{ getStatusIcon(appointment.status) }}
          </mat-icon>
          {{ getStatusText(appointment.status) }}
        </div>
      </div>
    }
  } @else {
    <div class="no-appointments">
      <mat-icon>event_available</mat-icon>
      <p>لا توجد مواعيد</p>
    </div>
  }
</div>

          </div>
          }
        </div>
      </div>
      }
    </div>
  </div>

  <!-- Modal Overlay -->
  <div
    class="modal-overlay"
    [class.visible]="delayInputVisible || cancelConfirmVisible"
  >
    @if (delayInputVisible) {
    <div class="modal-container" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="delayInputVisible = false">
        <mat-icon>close</mat-icon>
      </button>
      <h3>تأجيل المواعيد</h3>
      <p>لليوم: {{ selectedDayForDelay | date : "fullDate" : "" : "ar" }}</p>

      <mat-form-field appearance="fill" class="full-width">
        <mat-label>مدة التأخير (دقائق)</mat-label>
        <input
          matInput
          type="number"
          [(ngModel)]="delayDuration"
          placeholder="أدخل عدد الدقائق"
        />
      </mat-form-field>

      <div class="modal-actions">
        <button mat-stroked-button (click)="delayInputVisible = false">
          إلغاء
        </button>
        <button mat-flat-button color="primary" (click)="submitDelayDuration()">
          تأكيد
        </button>
      </div>
    </div>
    } @if (cancelConfirmVisible) {
    <div class="modal-container" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="cancelConfirmVisible = false">
        <mat-icon>close</mat-icon>
      </button>
      <h3>تأكيد الإلغاء</h3>
      <p>
        هل تريد إلغاء مواعيد يوم
        {{ selectedDayForCancel | date : "fullDate" : "" : "ar" }}؟
      </p>

      <div class="modal-actions">
        <button mat-stroked-button (click)="cancelConfirmVisible = false">
          تراجع
        </button>
        <button mat-flat-button color="warn" (click)="confirmCancel()">
          تأكيد الإلغاء
        </button>
      </div>
    </div>
    }
  </div>
  <!-- Message Modal -->
  @if (showModal) {
  <div class="modal-overlay visible">
    <div
      class="modal-container message-modal"
      (click)="$event.stopPropagation()"
    >
      <div class="modal-icon">
        @if (modalType === 'success') {
        <mat-icon class="success-icon">check_circle</mat-icon>
        } @else if (modalType === 'error') {
        <mat-icon class="error-icon">error</mat-icon>
        } @else {
        <mat-icon class="info-icon">info</mat-icon>
        }
      </div>
      <h3>{{ modalMessage }}</h3>
      <div class="modal-actions">
        <button mat-flat-button color="primary" (click)="closeMessageModal()">
          موافق
        </button>
      </div>
    </div>
  </div>
  }
</div>
