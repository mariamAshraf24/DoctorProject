<div class="calendar-container" dir="rtl">
  <div class="calendar-content">
    <div class="side-calendar">
      <div class="calendar-card">
        <mat-calendar
          [(selected)]="selectedDate"
          (selectedChange)="onDateSelected($event)"
          [minDate]="minDate"
          [maxDate]="maxDate"
          class="custom-calendar"
        >
        </mat-calendar>
      </div>
    </div>

    <div class="main-calendar-view">
      @if (loading) {
      <div class="loading-overlay">
        <div class="loading-content">
          <mat-spinner diameter="50" color="accent"></mat-spinner>
          <p>جاري تحميل المواعيد...</p>
        </div>
      </div>
      } @else if (error) {
      <div class="error-overlay">
        <div class="error-content">
          <mat-icon class="error-icon">error_outline</mat-icon>
          <p>{{ error }}</p>
          <button
            mat-flat-button
            color="warn"
            (click)="loadAppointmentsForWeek()"
          >
            إعادة المحاولة
          </button>
        </div>
      </div>
      } @else {
      <div class="week-view-container">
        <div class="week-header">
          <div class="header-content">
            <button mat-icon-button class="nav-button" (click)="previousWeek()">
              <mat-icon>chevron_right</mat-icon>
            </button>
            <h2 class="week-title">{{ currentWeekRange }}</h2>
            <button mat-icon-button class="nav-button" (click)="nextWeek()">
              <mat-icon>chevron_left</mat-icon>
            </button>
          </div>
        </div>

        <div class="week-days-grid">
          @for (day of weekDays; track day.date) {
          <div class="day-column" [class.today]="isToday(day.date)">
            <div class="day-header">
              <div class="day-title">
                <h4>{{ day.date | date : "d" }} {{ day.dayName }}</h4>
              </div>
              <div class="day-actions">
                <button
                  mat-icon-button
                  [matMenuTriggerFor]="dayMenu"
                  class="action-button menu"
                >
                  <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #dayMenu="matMenu">
                  <button
                    mat-menu-item
                    (click)="openDelayInput(day.dateString)"
                  >
                    <mat-icon>schedule</mat-icon>
                    <span>تأجيل المواعيد</span>
                  </button>
                  <button
                    mat-menu-item
                    (click)="openCancelModal(day.dateString)"
                  >
                    <mat-icon>cancel</mat-icon>
                    <span>إلغاء المواعيد</span>
                  </button>
                </mat-menu>
              </div>
            </div>

            <div class="appointments-container">
              @if (day.appointments.length > 0) { @for (appointment of
              day.appointments; track appointment.id) {
              <div
                class="appointment-card"
                [class]="'status-' + appointment.status"
              >
                <div class="appointment-time-badge">
                  {{ appointment.startTime | slice : 0 : 5 }}
                </div>
                <div class="appointment-details">
                  <h4 class="patient-name">
                    {{ appointment.patientFullName }}
                  </h4>
                </div>
                <div class="appointment-status">
                  {{ getStatusText(appointment.status) }}
                </div>
              </div>
              } } @else {
              <div class="no-appointments">
                <mat-icon>event_available</mat-icon>
                <p>لا توجد مواعيد</p>
              </div>
              }
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>
  </div>

  <!-- Modal Overlay -->
  <div
    class="modal-overlay"
    [class.visible]="delayInputVisible || cancelConfirmVisible"
  >
    @if (delayInputVisible) {
    <div class="modal-container" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="delayInputVisible = false">
        <mat-icon>close</mat-icon>
      </button>
      <h3>تأجيل المواعيد</h3>
      <p>لليوم: {{ selectedDayForDelay | date : "fullDate" : "" : "ar" }}</p>

      <mat-form-field appearance="fill" class="full-width">
        <mat-label>مدة التأخير (دقائق)</mat-label>
        <input
          matInput
          type="number"
          [(ngModel)]="delayDuration"
          placeholder="أدخل عدد الدقائق"
        />
      </mat-form-field>

      <div class="modal-actions">
        <button mat-stroked-button (click)="delayInputVisible = false">
          إلغاء
        </button>
        <button mat-flat-button color="primary" (click)="submitDelayDuration()">
          تأكيد
        </button>
      </div>
    </div>
    } @if (cancelConfirmVisible) {
    <div class="modal-container" (click)="$event.stopPropagation()">
      <button class="modal-close" (click)="cancelConfirmVisible = false">
        <mat-icon>close</mat-icon>
      </button>
      <h3>تأكيد الإلغاء</h3>
      <p>
        هل تريد إلغاء مواعيد يوم
        {{ selectedDayForCancel | date : "fullDate" : "" : "ar" }}؟
      </p>

      <div class="modal-actions">
        <button mat-stroked-button (click)="cancelConfirmVisible = false">
          تراجع
        </button>
        <button mat-flat-button color="warn" (click)="confirmCancel()">
          تأكيد الإلغاء
        </button>
      </div>
    </div>
    }
  </div>
  <!-- Message Modal -->
  @if (showModal) {
  <div class="modal-overlay visible">
    <div
      class="modal-container message-modal"
      (click)="$event.stopPropagation()"
    >
      <div class="modal-icon">
        @if (modalType === 'success') {
        <mat-icon class="success-icon">check_circle</mat-icon>
        } @else if (modalType === 'error') {
        <mat-icon class="error-icon">error</mat-icon>
        } @else {
        <mat-icon class="info-icon">info</mat-icon>
        }
      </div>
      <h3>{{ modalMessage }}</h3>
      <div class="modal-actions">
        <button mat-flat-button color="primary" (click)="closeMessageModal()">
          موافق
        </button>
      </div>
    </div>
  </div>
  }
</div>
